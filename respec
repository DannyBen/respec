#!/usr/bin/env bash

usage() { 
  printf "respec %s - rspec convenience wrapper\n\n" "$VERSION"
  printf "Usage:\n"
  printf "  respec                Run specs normally\n"
  printf "  respec SEARCH         Run specs on a file matching SEARCH\n"
  printf "  respec focus          Run specs tagged with :focus\n"
  printf "  respec last [N]       Run specs modified in the last N minutes [10]\n"
  printf "  respec cont           Continue from last run\n"
  printf "  respec reset          Delete the persistence file\n"
  printf "  respec -h, --help     Show this message\n"
  printf "  respec -v, --version  Show version number\n"
}

print_in_color() {
  local color="$1"
  shift
  if [[ -z ${NO_COLOR+x} ]]; then
    printf "$color%b\e[0m\n" "$*";
  else
    printf "%b\n" "$*";
  fi
}

red() { print_in_color "\e[31m" "$*"; }
green() { print_in_color "\e[32m" "$*"; }
yellow() { print_in_color "\e[33m" "$*"; }
blue() { print_in_color "\e[34m" "$*"; }
magenta() { print_in_color "\e[35m" "$*"; }
cyan() { print_in_color "\e[36m" "$*"; }

unpersist() {
  rm -f "spec/persist.txt"
}

run() {
  case "$1" in
    "" )
      unpersist
      bundle exec rspec
      ;;

    f | focus )
      magenta "respec: focus"
      bundle exec rspec --tag focus
      ;;

    l | last )
      shift
      m="${1:-10}"
      magenta "respec: last $m minutes"
      bundle exec rspec $((find -name '*_spec.rb' -mmin -$m | grep .) || echo "-tnothing")
      ;;

    c | cont | continue )
      magenta "respec: continue"
      bundle exec rspec --next-failure --tag last_run_status:unknown
      ;;

    r | reset )
      magenta "respec: delete persistence file"
      unpersist
      ;;

    -h | --help )
      usage
      ;;

    -v | --version )
      echo "$VERSION"
      ;;

    * )
      search="$1"
      magenta "respec: files matching *$search*"
      bundle exec rspec --pattern "spec/**/*$search*_spec.rb"
      ;;

  esac
}

VERSION="0.0.2"
set -e
run "$@"
